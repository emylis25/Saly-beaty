<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Lista de Citas</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap JS (para funcionalidades como modales, dropdowns, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        .table th, .table td {
            vertical-align: middle;
            text-align: center;
        }
        .btn-action {
            margin: 2px;
        }
    </style>
</head>
<div th:replace="~{layout/navbar :: navbar}"></div>

<body>
<div class="container mt-4">

    <h1 class="mb-4">Listado de Citas</h1>

    <div class="mb-3" sec:authorize="hasRole('ADMIN')">
        <a th:href="@{/citas/reportegeneral/attachment}" class="btn btn-outline-primary me-2">Descargar reporte general</a>
        <a th:href="@{/citas/reportegeneral/inline}" target="_blank" class="btn btn-outline-primary">Imprimir reporte general</a>
    </div>

    <!-- Botón Nueva cita solo para CLIENTE -->
    <div class="mb-3" sec:authorize="hasRole('CLIENTE')">
        <a class="btn btn-primary" th:href="@{/citas/nueva}">Nueva Cita</a>
    </div>
    <div class="card-body">
        <form th:action="@{/citas/listarCitas}" method="get" class="row g-3 align-items-end">

            <!-- Filtro por Trabajador -->
            <div class="col-md-5">
                <label for="nombreTrabajador" class="form-label">Nombre del Trabajador</label>
                <input type="text" class="form-control" id="nombreTrabajador" name="nombreTrabajador"
                       th:value="${param.nombreTrabajador}" placeholder="Ej: Miguel">
            </div>

            <!-- Filtro por Cliente -->
            <div class="col-md-5">
                <label for="nombreCliente" class="form-label">Nombre del Cliente</label>
                <input type="text" class="form-control" id="nombreCliente" name="nombreCliente"
                       th:value="${param.nombreCliente}" placeholder="Ej: Sara">
            </div>

            <!-- Botón de búsqueda -->
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-primary">Buscar</button>
            </div>

        </form>

    <table class="table table-bordered table-hover table-striped align-middle">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Servicio</th>
            <th>Trabajador</th>
            <th>Fecha</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="cita : ${citas.content}">
            <td th:text="${cita.id}"></td>
            <td th:text="${cita.cliente.nombre}"></td>
            <td th:text="${cita.servicio.nombreServicio}"></td>
            <td th:text="${cita.trabajador.nombre}"></td>
            <td th:text="${#temporals.format(cita.fechaHora, 'dd/MM/yyyy HH:mm')}"></td>
            <td>
                <!-- Botón Editar solo para CLIENTE -->
                <a class="btn btn-sm btn-warning"
                   th:href="@{'/citas/editar/' + ${cita.id}}"
                   sec:authorize="hasRole('CLIENTE')">
                    Editar
                </a>

                <!-- Botón Eliminar solo para ADMIN -->
                <form th:action="@{'/citas/eliminar/' + ${cita.id}}"
                      method="post"
                      sec:authorize="hasRole('ADMIN')"
                      style="display:inline;">
                    <button class="btn btn-sm btn-danger"  type="submit">Eliminar</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- 📄 Paginación -->
    <nav th:if="${citas.totalPages > 1}">
        <ul class="pagination justify-content-center">
            <li class="page-item" th:classappend="${citas.first} ? 'disabled'">
                <a class="page-link" th:href="@{/citas(page=${citas.number - 1}, nombreTrabajador=${nombreTrabajador}, nombreCliente=${nombreCliente})}">Anterior</a>
            </li>
            <li class="page-item" th:each="i : ${#numbers.sequence(0, citas.totalPages-1)}"
                th:classappend="${i == citas.number} ? 'active'">
                <a class="page-link" th:href="@{/citas(page=${i}, nombreTrabajador=${nombreTrabajador}, nombreCliente=${nombreCliente})}"
                   th:text="${i + 1}"></a>
            </li>
            <li class="page-item" th:classappend="${citas.last} ? 'disabled'">
                <a class="page-link" th:href="@{/citas(page=${citas.number + 1}, nombreTrabajador=${nombreTrabajador}, nombreCliente=${nombreCliente})}">Siguiente</a>
            </li>
        </ul>
    </nav>
</div>
</div>




<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
